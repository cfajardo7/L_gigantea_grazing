---
title: "2024_06_Chlorophyll_Abundance"
author: "Cindy Fajardo"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "../Output/")
```

#Libraries
```{r, Libraries}
library("rerddap")
library(tidyverse)
library("tidync")
library("doParallel")
library(lubridate)
library(patchwork)
library(viridis)
library(here)
library(kableExtra)
library(hrbrthemes)
library(emmeans)
library(agricolae)
library(vegan)
library(performance)
library(broom)
library(car)
library(lme4)
library(lmerTest)
library(pscl)
library(ggridges)
library(devtools)
library(gcookbook)
library(ggsci)
library(Hmisc)
library(ggpubr)
```

#Read in CSV
```{r, Read in CSV}
orig_spec_chl_abun <- read_csv(here("Data","Chlorophyll_absorbance_data_sheet_orig.csv"))
master_PAM <- read_csv(here("Data", "2024_Spring_PAM_Master.csv"))

```

#Spectophotometry Data Manipulation
```{r, Spectophotometry Data Manipulation}
chl_abun <- orig_spec_chl_abun %>%
  separate(col = Plate_ID,
           into = c("Plate", "ID"),
           sep = "_") %>%
  mutate(Path_length_cm = Path_lenght_mm/10) %>% 
  mutate(ug_ml = ((Abun_665-Abun_750)/Path_length_cm),
         ug = ug_ml *Metha_vol,
         ug_cm2 = ug/SA_cm_2) %>% 
  group_by(Plate, Group) %>% 
  summarise(mean_ug_cm2 = mean(ug_cm2 ),
            se_ug_cm2 = sd(ug_cm2)/sqrt(n())) %>% 
  mutate(Group = as.factor(Group))%>% 
  mutate(Plate_Type = case_when(
    Plate %in% c("C1","C2","C3","C4") ~ "Control",
    Plate %in% c("F1","F2","F3","F4","F6","F7","F8","F10","F5") ~ "Female",
    Plate %in% c("M1","M2","M3","M4","M5","M6","M8","M9","M10") ~ "Male",
    Plate %in% ("UK") ~ "Unknown"))
  
```


#Chl Concentration Boxplot
```{r, Chl Concentration Boxplot}
chl_conc_boxplot <-chl_abun %>% 
  filter(Plate_Type != "Unknown") %>% 
  ggplot(aes(x=Plate_Type,
         y = mean_ug_cm2,
         fill = Plate_Type))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = "Chlorophyll Concentration",
       fill = "Plate_Type",
       x = "Cage Type",
       y = "Chlorophyll Concentration μg/cm²")+
  scale_fill_bmj()+
  theme_bw()
  
chl_conc_boxplot


```

#Only Females and Males
```{r, Only Females and Males}
orig_only_fem_male <- orig_spec_chl_abun %>%
  separate(col = Plate_ID,
           into = c("Plate", "ID"),
           sep = "_") %>%
  mutate(Path_length_cm = Path_lenght_mm/10) %>% 
  mutate(ug_ml = ((Abun_665-Abun_750)/Path_length_cm),
         ug = ug_ml *Metha_vol,
         ug_cm2 = ug/SA_cm_2) %>% 
  group_by(Plate, Group) %>% 
  summarise(mean_ug_cm2 = mean(ug_cm2 ),
            se_ug_cm2 = sd(ug_cm2)/sqrt(n())) %>% 
  mutate(Group = as.factor(Group)) %>% 
  mutate(Plate_Type = case_when(
    Plate %in% c("C1","C2","C3","C4") ~ "Control",
    Plate %in% c("F1","F2","F3","F4","F6","F7","F8","F10","F5") ~ "Female",
    Plate %in% c("M1","M2","M3","M4","M5","M6","M8","M9","M10") ~ "Male",
    Plate %in% ("UK") ~ "Unknown")) %>% 
  filter(Plate_Type != "Control") %>% 
  filter(Plate_Type != "Unknown") %>% 
  mutate(Group = case_when(
    Plate %in% c("F1", "M1") ~ "1",
    Plate %in% c("F2", "M2") ~ "2",
    Plate %in% c("F3", "M3") ~ "3",
    Plate %in% c ("F4", "M4") ~ "4",
    Plate %in% c("F5", "M5") ~ "5",
    Plate %in% c("F6", "M6") ~ "6",
    Plate %in% c("F7") ~"7",
    Plate %in% c("F8", "M8") ~"8",
    Plate %in% c("M9") ~ "9",
    Plate %in% c("F10", "M10") ~"10"))
```

#Chlorophyl Paired Graph
```{r, Paired Graph}
orig_paired_graph <- orig_only_fem_male %>% 
  ggplot(aes(x = Plate_Type, 
             y = mean_ug_cm2)) +
  stat_summary(aes(group = Group), 
               fun = mean, 
               geom = "path",
               show.legend = FALSE) +
  stat_summary(aes(color = Plate), 
               fun.data = mean_cl_boot,
               show.legend = FALSE) +
  stat_summary(aes(color = Group), 
               fun = mean, 
               geom = "point", 
               size = 4,
               show.legend = FALSE) +
  geom_point(aes(color = Group),
             show.legend = FALSE)+
  labs(title = "Chlorophyll Concentartion of Paired Female and Male Cages",
       x = "Cage Type",
       y = "Chlorophyll Concentration μg/mm²")+
  theme_bw()

orig_paired_graph

```

#General Linear Models
```{r, General Linear Models}
Mod_chl<-lmer(mean_ug_cm2~Plate_Type+(1|Group), data = orig_only_fem_male %>%
                filter(Plate_Type %in% c("Male","Female")) ) # you are getting the singularity warning because you have two points without a pair
anova(Mod_chl)
summary(Mod_chl)

#post hoc test
emmeans(Mod_chl, list(pairwise~Plate_Type), adjust = "tukey")
```
#PAM Data Manipulation For Plate Type
```{r, PAM Data Manipulation}
PAM_average_Jun_Nine <- master_PAM %>% 
  filter(Date != "2024_06_24") %>% 
  group_by(Plate_ID, Group, Plate_Type) %>% 
  summarise(mean_F0 = mean(F0))

PAM_average_Jun_24<- master_PAM %>% 
  filter(Date == "2024_06_24") %>% 
  group_by(Plate_ID, Group, Plate_Type) %>% 
  summarise(mean_F0 = mean(F0))
```


#PAM Data Boxplots
```{r, PAM Data Boxplot}
June_Nine_PAM_boxplot <- ggplot(PAM_average_Jun_Nine,
                      aes(x=Plate_Type,
                          y=mean_F0,
                          fill=Plate_Type))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = "Average Florescence Readings Per Plate Type",
       x = "Cage Type",
       y = "Average F0")+
  scale_fill_bmj()+
  theme_bw()
June_Nine_PAM_boxplot

June_24_PAM_boxplot<- ggplot(PAM_average_Jun_24,
                      aes(x=Plate_Type,
                          y=mean_F0,
                          fill=Plate_Type))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = "Average Florescence Readings Per Plate Type",
       x = "Cage Type",
       y = "Average F0")+
  scale_fill_bmj()+
  theme_bw()
June_24_PAM_boxplot

```

#PAM Lineplot for Avegarges Per Cage
```{r, Lineplot for Avegarges Per Cage}
PAM_ave_per_plate <- master_PAM %>% 
  group_by(Plate_ID, Group) %>% 
  summarise(PAM_average = mean(F0)) %>% 
  mutate(log_F0 = log(PAM_average+1))

Plate_line_plot <- ggplot(PAM_ave_per_plate,
                      aes(x=Plate_ID,
                          y=PAM_average,
                          color = Plate_ID))+
  geom_point(show.legend = FALSE)+
  geom_line(color= "black",
            group=1,
            show.legend = FALSE)+
  labs(title = "Average PAM Readings Per Plate",
       x = "Plate Name",
       y = "PAM Reading Average")+
  scale_fill_bmj()+
  theme_bw()
Plate_line_plot

```

#Statistics for PAM
Statistical question: Are the mean florescence different between male and female cages
```{r}
#data manipulation for t test
mal_fem_fo <- PAM_average_Jun_24 %>% 
  filter(Plate_Type!="Control") %>% #filtered out controls
  mutate(var_F0 = var(mean_F0),
         log_F0 = log(mean_F0+1)) #data was not normal, log transformed and added 1 since data had many 0's
ggqqplot(mal_fem_fo$log_F0) #check for normality
F0_ttest <- t.test(log_F0~Plate_Type, var.equal=TRUE, data = mal_fem_fo)
F0_ttest

F0_average <- master_PAM %>% 
  group_by(Plate_Type, Group) %>% 
  summarise(mean_F0 = mean(F0)) %>% 
  mutate(log_F0 = log(mean_F0+1))
F0_model <- lm(log_F0~Plate_Type, data = F0_average )
anova(F0_model)
summary(F0_model)

```

#join PAM data and chlorophyll data
This is a left join that was made before the addition of the June 9-10 data. Do I average out the F0 readings by date and then do the join?
```{r, join PAM data and chlorophyll data}
#full_data_PAM_CH <- PAM_average %>% 
  #rename(Plate=Plate_ID) %>% 
  #mutate(Group=factor(Group)) %>% 
  #left_join(chl_abun)
```
#scatterplot of full data
This was made with the joined data from above. Change as neccesary
```{r, scatterplot of full data}
#scatter_full <- ggplot(full_data_PAM_CH,
                       #aes(x=mean_F0,
                           #y=mean_ug_cm2))+
  #geom_point()+
  #geom_smooth(method="lm") #regression line, add method = lm 
#scatter_full
```

#PAM Average Grouped Data By Date 
```{r, PAM Average Grouped Data By Date}
PAM_average_Jun_9 <- master_PAM %>% 
  filter(Date != "2024_06_24",
         Plate_Type != "Control") %>% 
  group_by(Plate_Type, Group, Plate_ID) %>% 
   mutate(Group = as.factor(Group)) %>% 
  summarise(mean_F0 = mean(F0))

Jun_Nine_PAM_paired_graph <- PAM_average_Jun_9 %>% 
  ggplot(aes(x = Plate_Type, 
             y = mean_F0)) +
  stat_summary(aes(group = Group), 
               fun = mean, 
               geom = "path",
               show.legend = FALSE) +
  stat_summary(aes(color = Plate_ID), 
               fun.data = mean_cl_boot,
               show.legend = FALSE) +
  stat_summary(aes(color = Group), 
               fun = mean, 
               geom = "point", 
               size = 4,
               show.legend = FALSE) +
  geom_point(aes(color = Group),
             show.legend = FALSE)+
  labs(title = "Florescence of Paired Female and Male Cages",
       x = "Cage Type",
       y = "Average Florescence")+
  theme_bw()

Jun_Nine_PAM_paired_graph

PAM_average_6_24 <- master_PAM %>% 
  filter(Date == "2024_06_24",
         Plate_Type != "Control") %>% 
  group_by(Plate_Type, Group, Plate_ID) %>% 
   mutate(Group = as.factor(Group)) %>% 
  summarise(mean_F0 = mean(F0))

Jun_24_PAM_paired_graph <- PAM_average_6_24 %>% 
  ggplot(aes(x = Plate_Type, 
             y = mean_F0)) +
  stat_summary(aes(group = Group), 
               fun = mean, 
               geom = "path",
               show.legend = FALSE) +
  stat_summary(aes(color = Plate_ID), 
               fun.data = mean_cl_boot,
               show.legend = FALSE) +
  stat_summary(aes(color = Group), 
               fun = mean, 
               geom = "point", 
               size = 4,
               show.legend = FALSE) +
  geom_point(aes(color = Group),
             show.legend = FALSE)+
  labs(title = "Florescence of Paired Female and Male Cages",
       x = "Cage Type",
       y = "Average Florescence")+
  theme_bw()

Jun_24_PAM_paired_graph
```

#raw data
```{r, raw data}

```

